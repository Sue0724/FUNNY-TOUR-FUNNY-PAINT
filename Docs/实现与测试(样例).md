<!-- TOC -->

- [1. 系统实现](#1-系统实现)
    - [1.1. 运行环境](#11-运行环境)
    - [1.2. 关键函数说明](#12-关键函数说明)
        - [1.2.1. map_index.js(地图主页模块)](#121-map_indexjs地图主页模块)
        - [1.2.2. map_choose_places.js(选择地点模块)](#122-map_choose_placesjs选择地点模块)
        - [1.2.3. map_canvas.js(绘画模块)](#123-map_canvasjs绘画模块)
        - [1.2.4. trip.js(日程模块)](#124-tripjs日程模块)
        - [1.2.5. my_trips.js(行程列表显示模块)](#125-my_tripsjs行程列表显示模块)
- [2. 系统测试](#2-系统测试)
    - [2.1. 测试用例](#21-测试用例)
        - [2.1.1. auth.py（用户模块）](#211-authpy用户模块)
            - [2.1.1.1. register函数](#2111-register函数)
            - [2.1.1.2. login函数](#2112-login函数)
            - [2.1.1.3. load_logged_in_user函数](#2113-load_logged_in_user函数)
        - [2.1.2. hustcourse.py（主页）](#212-hustcoursepy主页)
            - [2.1.2.1. index函数测试](#2121-index函数测试)
            - [2.1.2.2. message2](#2122-message2)
    - [2.2. 结果分析](#22-结果分析)

<!-- /TOC -->
<a id="markdown-1-系统实现" name="1-系统实现"></a>
# 1. 系统实现
<a id="markdown-11-运行环境" name="11-运行环境"></a>
## 1.1. 运行环境
计算机环境：Windows 11  
处理器：11th Gen Intel(R) Core(TM)   i7-1165G7 @ 2.80GHz   2.80 GHz  
内存（RAM）：16.0 GB (15.7 GB 可用)  
系统类型：64 位操作系统, 基于 x64 的处理器  
编程语言：JavaScript  
程序框架：前端：微信小程序，后端：微信云开发（云函数），数据库：微信云开发数据库  
IDE：微信开发者工具  
实现语言：JavaScript+WXSS  

<a id="markdown-12-关键函数说明" name="12-关键函数说明"></a>
## 1.2. 关键函数说明
<a id="markdown-121-map_index.js地图主页模块" name="121-map_index.js地图主页模块"></a>
### 1.2.1. map_index.js(地图主页模块)

1. navigateToDrawMode函数：  
入口参数：无  
返回值：无  
功能：跳转至绘画模式map_canvas页面。  
实现：使用wx.navigateTo实现跳转。  

2. navigateToPlaceMode函数  
入口参数：无  
返回值：无  
功能：跳转至地点选择模式map_choose_places页面。  
实现：使用wx.navigateTo实现跳转。  

3. navigateToTripMode函数  
入口参数：无  
返回值：无  
功能：跳转至日程模式trip页面。  
实现：使用wx.navigateTo实现跳转。  

4. saveMap函数  
入口参数：无  
返回值：无  
功能：保存地图，将前端行程数据传入后端数据库trips表。  
实现：获取全局变量，判断当前是否为已登录状态，若是则将相应数据存入数据库。  

5. getMapData函数  
入口参数：trip_name行程名  
返回值：无  
功能：获取当前用户创建的名为trip_name的行程数据。  
实现：使用wx.cloud.database()获取云数据库实例，从全局变量获取当前登录的用户名zhanghao，查询trips表获取行程数据，查询条件字段为zhanghao和trip_name。  

6. onLoad函数  
入口参数：options页面跳转传递的参数  
返回值：无  
功能：从数据库中获取行程数据，初始化画布上下文，显示日程地点及绘画。  
实现：从options中获得trip_name，从数据库trips表查询获取行程数据并更新到全局变量，初始化画布上下文，根据经纬度坐标标定屏幕坐标，渲染绘画路径。  

7. onShow函数  
入口参数：无  
返回值：无  
功能：从全局变量更新行程数据，更新显示日程地点及绘画。  
实现：从全局变量更新行程数据，根据经纬度坐标标定屏幕坐标，重新渲染绘画路径。  

<a id="markdown-122-map_choose_places.js选择地点模块" name="122-map_choose_places.js选择地点模块"></a>
### 1.2.2. map_choose_places.js(选择地点模块)

1. chooseCenter函数  
入口参数：无  
返回值：无  
功能：设定行程中心。  
实现：调用wx.chooseLocation接口，根据返回信息创建新的marker，id固定为0，并加入相应marker列表。  

2. choosePlace函数  
入口参数：无  
返回值：无  
功能：添加自选地点。  
实现：调用wx.chooseLocation接口，根据返回信息创建新的marker，markerId递增，并加入相应marker列表。  

3. onSearchInput函数   
入口参数：event点击事件  
返回值：无  
功能：监听搜索框输入并保存到searchQuery中。  
实现：将event.detail.value赋值给页面变量searchQuery，使用this.setData更新。  

4. onSearchNearbySubmit函数  
入口参数：无  
返回值：无   
功能：处理搜索按钮点击事件，搜索周边。  
实现：切换图标显示以回应用户交互，调用onSearchNearby函数搜索周边地点。  

5. onUnload函数  
入口参数：无  
返回值：无  
功能：更新全局变量中的行程数据。  
实现：在每次关闭页面时用相应行程数据更新全局变量。  

6. onTapMap函数  
入口参数：e 地图点击事件  
返回值：无  
功能：地图选点。  
实现：调用逆地址解析API，提取地址信息，创建地点marker，并加入相应地点列表。  

7. onTapPoi函数  
入口参数：e  
返回值：无  
功能：地图选点（POI）。  
实现：从传入事件参数中提取POI名称等信息，创建地点marker，并加入相应地点列表。  

8. searchNearbyWithQuery函数  
入口参数：lat纬度, lng经度, keyword关键词  
返回值：无  
功能：根据经纬度及关键词进行周边搜索。  
实现：调用周边搜索API，提取地点并创建地点marker，加入相应地点列表。  

9. onSearchNearby函数  
入口参数：无  
返回值：无  
功能：调用周边搜索功能。    
实现：从页面变量中获取行程中心经纬度chosenFixedLatitude、chosenFixedLongitude及搜索输入关键词searchQuery，并调用searchNearbyWithQuery函数。  

10. onPlaceTap函数  
入口参数：e  
返回值：无  
功能：屏幕中心显示所点击的地点。  
实现：从传入点击事件参数中获取用户在地点列表中点击的地点的id，将地图显示中心修改为所选地点的经纬度，并提高地图缩放级别。  

11. onMarkerTap函数  
入口参数：e  
返回值：无  
功能：选择地点，展示地点操作菜单。  
实现：从传入点击事件参数中获取用户点击的地点图标对应的地点id，设置展示地点操作菜单变量为true。  

12. onActionTap函数  
入口参数：e  
返回值：无  
功能：调用所选操作对应的功能函数。  
实现：使用switch选择调用相应的功能函数。  

13. collectPlace函数  
入口参数：无  
返回值：无  
功能：将所选地点加入收藏地点。  
实现：调用this.setData更新收藏地点列表。  

14. addPlace函数  
入口参数：无  
返回值：无  
功能：将所选地点加入行程地点。  
实现：调用this.setData更新行程地点列表。  

15. outerNavigate函数   
入口参数：无  
返回值：无  
功能：跳转外部导航。  
实现：使用wx.openLocation方法，传入所选地点经纬度，跳转外部地图app进行导航。  

16. showDetail函数  
入口参数：无  
返回值：无  
功能：显示地点详情。  
实现：构建跳转URL，并编码参数，跳转网页显示地点详情。  

<a id="markdown-123-map_canvas.js绘画模块" name="123-map_canvas.js绘画模块"></a>
### 1.2.3. map_canvas.js(绘画模块)

1. toggleDrawMode函数  
入口参数：无  
返回值：无  
功能：进入绘画编辑或退出绘画编辑（退出绘画编辑后可以自由拖动、缩放地图）。  
实现：切换绘画模式布尔值，进入绘画模式则将currentTool赋值为'brush'，使用this.setData更新页面变量。  

2. getTopLeftLatLng函数  
入口参数：无  
返回值：无  
功能：获取地图左上角经纬度。  
实现：使用地图上下文getRegion方法获取地图显示部分的左上角经纬度。  

3. getMapCenterLatLng函数  
入口参数：无  
返回值：无  
功能：获取地图中心点经纬度。  
实现：使用地图上下文getCenterLocation方法获取地图显示部分的中心经纬度。  

4. convertScreenToLatLng函数  
入口参数：x, y屏幕坐标  
返回值：{latitude, longitude}  
功能：将屏幕坐标转换为经纬度。  
实现：根据比例公式将屏幕坐标转换为经纬度。  

5. convertLatLngToScreen函数  
入口参数：lng, lat经纬度  
返回值：{x, y}  
功能：将经纬度转换为屏幕坐标。  
实现：根据比例公式将经纬度转换为屏幕坐标。  
 
6. startMove函数  
入口参数：direction  
返回值：无  
功能：在绘画编辑时根据方向移动地图。  
实现：根据direction修改地图显示中心经纬度坐标，使用this.setData更新页面变量。  

7. onLoad函数  
入口参数：options  
返回值：无  
功能：初始化画布上下文，从全局变量获取行程数据，根据显示地图经纬度标定屏幕坐标，渲染显示绘画路径。  
实现：使用wx.createSelectorQuery获取画布并调用init函数设定画布宽高，从全局变量获取行程数据，调用setCurrentCoordinate函数根据显示地图经纬度标定屏幕坐标，调用renderPaths函数渲染显示绘画路径。  

8. setCurrentCoordinate函数  
入口参数：无  
返回值：无  
功能：根据显示地图经纬度标定屏幕坐标。  
实现：调用getTopLeftLatLng、getMapCenterLatLng函数获取地图左上角和中心的经纬度，计算地图中心到左上角的经纬度差异，计算屏幕中心到左上角的屏幕坐标差异，使用this.setData更新页面数据。  

9. onMapMove函数  
入口参数：e  
返回值：无  
功能：开始拖动时隐藏绘画，结束拖动后显示绘画。  
实现：e.type为"begin"时调用画布上下文clearRect方法清空画布；e.type为"end"时调用setCurrentCoordinate函数标定坐标，再调用renderPaths重新显示绘画路径。  

10. renderPaths函数  
入口参数：ctx画布上下文  
返回值：无  
功能：渲染全部绘画路径  
实现：将路径列表paths中的每条路径的起点和终点经纬度转换为屏幕坐标，读取路径绘画线条的显色及粗细大小，调用画布组件的方法绘制路径。  

11. changeColor函数  
入口参数：e  
返回值：无  
功能：选择画笔颜色。  
实现：更新页面变量colorType的rgb值为选择的值。  

12. changeLineWidth函数  
入口参数：e  
返回值：无  
功能：选择画笔粗细大小。  
实现：更新页面变量lineWidth的值为选择的值。  
 
13. erasePath函数  
入口参数：x, y  
返回值：无  
功能：擦除绘画。  
实现：从paths列表中删除距离屏幕坐标x, y距离小于容忍度的路径，并调用renderPaths重新渲染显示路径。  

14. pointToLineDistance函数  
入口参数：point, start线段起点, end线段终点  
返回值：无  
功能：计算点到线段的距离。  
实现：根据数学公式计算点到线段的距离。  

15. touchStart函数  
入口参数：e  
返回值：无  
功能：用户触摸画布开始时触发（开始绘制）。  
实现：将触摸点屏幕坐标转换为经纬度并保存  

16. touchMove函数  
入口参数：e  
返回值：无  
功能：用户在画布上滑动手指时触发（绘制或擦除过程）。  
实现：从传入参数获取触摸点的屏幕坐标，渲染新增绘制路径，将路径起点（上次触摸点）、终点（当前触摸点）转换为经纬度，及画笔颜色、线条粗细作为一个path数据保存入paths列表，将当前触摸点记录为上次触摸点。  

17. onUnload函数  
入口参数：无  
返回值：无  
功能：更新全局变量。  
实现：用相应页面变量更新全局变量。  

18. selectBrush函数  
入口参数：无  
返回值：无  
功能：选择画笔。  
实现：修改页面变量currentTool值为'brush'。  

19. selectEraser函数  
入口参数：无  
返回值：无  
功能：选择橡皮擦。  
实现：修改页面变量currentTool值为'eraser'。  

<a id="markdown-124-trip.js日程模块" name="124-trip.js日程模块"></a>
### 1.2.4. trip.js(日程模块)

1. onPlaceTap函数  
入口参数：e  
返回值：无  
功能：选择地点。  
实现：从入口参数获取所选地点id。  

2. submitDay函数  
入口参数：无  
返回值：无  
功能：修改地点所属日程。  
实现：用输入数字更新地点所属日程并对行程地点重新排序。  

3. submitDaySeq函数  
入口参数：无  
返回值：无  
功能：修改地点在所属日程内的游览顺序。  
实现：用输入数字更新地点在所属日程内的游览顺序并对行程地点重新排序。  

4. delete函数  
入口参数：无  
返回值：无  
功能：删除行程地点。  
实现：从地点列表中删除所选地点id对应地点。  

5. setStart函数  
入口参数：无  
返回值：无  
功能：将所选地点设为导航起点。  
实现：更新页面变量startMarker为所选地点。  

6. setEnd函数  
入口参数：无  
返回值：无  
功能：将所选地点设为导航终点。  
实现：更新页面变量endMarker为所选地点。  

7. navigate函数  
入口参数：type  
返回值：无  
功能：路线规划。  
实现：根据type值调用相应类型的路线规划API，调用decodePolyline解压路线地点坐标列表，在地图上绘制路线polyline。  

8. decodePolyline函数  
入口参数：coors解压前的坐标列表  
返回值：decodedCoords  
功能：解压路线地点坐标列表。  
实现：根据解压算法解压路线地点坐标列表。  

<a id="markdown-125-my_trips.js行程列表显示模块" name="125-my_trips.js行程列表显示模块"></a>
### 1.2.5. my_trips.js(行程列表显示模块)

1. getMyTrips函数  
入口参数：无  
返回值：无  
功能：从数据库查询我创建的行程数据。  
实现：根据当前账号zhanghao查询数据库获取我的行程数据至页面变量列表my_trips。  

2. onLoad函数  
入口参数：options  
返回值：无  
功能：加载页面时加载行程数据。  
实现：调用getMyTrips函数。  

3. onSearchInputChange函数  
入口参数：e  
返回值：无  
功能：搜索输入框内容变化时触发，根据搜索内容过滤行程。  
实现：从事件e获取搜索字符串至页面变量searchQuery，调用filterTrips函数，修改页面变量filteredTrips为行程名包含搜索字符串的行程列表；若字符串为空则显示全部行程。  

4. filterTrips函数  
入口参数：无  
返回值：无  
功能：根据搜索内容过滤行程。  
实现：修改全局变量filteredTrips为行程名包含搜索字符串的行程列表。  

5. showEditInput函数  
入口参数：event  
返回值：无  
功能：显示修改行程名称的输入框。  
实现：获取正在编辑的行程的原名称并保存至页面变量edit_trip_name。  

6. onTripNameInputChange函数
入口参数：event  
返回值：无  
功能：更新输入框内容时，读取更新的字符串。  
实现：从event读取输入字符串，保存至页面变量inputTripName。  

7. submitTripName函数  
入口参数：无  
返回值：无  
功能：提交更新trip_name。  
实现：根据edit_trip_name查询数据库行程表项，更新数据库中的trip_name字段，若找到符合条件的记录，进行更新；若没有找到符合条件的记录，创建新记录。更新或创建成功后，更新本地数据并隐藏输入框。  

8. navigateToMapCanvas函数  
入口参数：event  
返回值：无  
功能：跳转到地图画布页面。  
实现：使用wx.navigateTo跳转页面，传递行程名参数tripName以供跳转页面读取相应行程数据。  

9. onShow函数  
入口参数：无  
返回值：无  
功能：返回页面时重新加载行程数据，清空上一个行程遗留的全局变量。  
实现：调用getMyTrips函数，清空行程相关的全局变量。

<a id="markdown-2-系统测试" name="2-系统测试"></a>
# 2. 系统测试
<a id="markdown-21-测试用例" name="21-测试用例"></a>
## 2.1. 测试用例
<a id="markdown-211-authpy用户模块" name="211-authpy用户模块"></a>
### 2.1.1. auth.py（用户模块）
<a id="markdown-2111-register函数" name="2111-register函数"></a>
#### 2.1.1.1. register函数
用户注册模块，首先要判断用户填写的数据是不是符合我们对数据的要求，如果用户填写的数据不符合我们的要求，则要返回响应的报错。

用例描述|结果|截图
--|--|--
用户不填用户名的情况|返回报错信息，Username is required 提示用户没有输入用户名。|![](images/t1.png)
用户不输入密码|网页返回了报错信息，Password is required，提示用户没有输入密码。|![](images/t2.png)
之前注册了一个用户名为222222的用户，这里如果我们尝试重复注册|返回报错信息User 222222 is already registed，提示当前用户名已经被注册过了。|![](images/t3.png)
正确注册之后|页面会成功跳转|![](images/t4.png)

<a id="markdown-2112-login函数" name="2112-login函数"></a>
#### 2.1.1.2. login函数
根据login函数的实现，我们可以知道，login函数有种情况
1. 用户输入的用户名不在数据库中
2. 用户的用户名在数据库中，但是密码不对应。
3. 成功登陆

我们分别就这三个情况进行测试：

用例描述|结果|截图
--|--|--
用户输入的用户名不在数据库中|网页成功的返回了Incorrect username.|![](images/t5.png)
用户输入的密码和用户名不对应|我们输入了222222和111111，222222对应密码也是222222，这里密码不对应，因此返回的是Incorrect password.|![](images/t6.png)
成功登陆的情况|当登陆成功时，会返回一个登陆成功的弹窗，点击确定后会自动跳转到主页面中。|![](images/t7.png)

<a id="markdown-2113-load_logged_in_user函数" name="2113-load_logged_in_user函数"></a>
#### 2.1.1.3. load_logged_in_user函数
我们测试其有用户登录和没有用户等的两种输出情况

用例描述|结果|截图
--|--|--
无用户登录| |![](images/t8.png)
有用户登录|成功登录的时候会得到对应的会话的user_id，有了user_id我们便可通过数据库结果获取用户的信息。方便后续的操作。|![](images/t9.png)

<a id="markdown-212-hustcoursepy主页" name="212-hustcoursepy主页"></a>
### 2.1.2. hustcourse.py（主页）
<a id="markdown-2121-index函数测试" name="2121-index函数测试"></a>
#### 2.1.2.1. index函数测试
index测试，index只负责主页面的加载和渲染，所以我们仅需测试不同情况下的主页面的变化。我们分成三个测试
1. 无登录状态的测试。
2. 登录状态的测试
3. 注销的测试、
关于对应从数据库中加载所有的课程的功能和其他的一些功能将在后面对应的特定函数进行测试。

用例描述|结果|截图
--|--|--|--|--|
无登录状态的测试|可以看到右上角的状态是登录和注销，此时点击登陆，会跳转到登录页面。登陆页面可见上文|![](images/t10.png)
登录状态的测试|以222222身份登录之后，主页的右上角将会变成对应用户的用户名或昵称|![](images/t11.png)
注销的测试|此时我们点击注销，会登出我们的登录状态，变成登录前的样子|![](images/t12.png)

<a id="markdown-2122-message2" name="2122-message2"></a>
#### 2.1.2.2. message2
由于上面的主页已经测试了正常使用的结果，所以我们此处仅测试没有登录情况下的注销功能

***由于测试用例较多，省略之后的测试用例描述***

<a id="markdown-22-结果分析" name="22-结果分析"></a>
## 2.2. 结果分析
根据测试分析运行结果、确认软件是否满足需求。
由测试结果图1，2，3，4可知，其能够完成用户账号的创建以及前后端消息的通信。并且能够根据对应前端的数据中的一些错误向前端返回一定的报错信息，确认数据无误后将其装入用户数据库中。用户注册功能完整实现。
由测试结果图5，6，7，所示，可以看到，用户登录模块可以获得前端传入的数据，并且检查前端传递过来的数据是否正确，如果不正确，向其返回对应的报错信息，如果正确向前端返回一个登录成功的消息，其中数据正不正确是通过调用数据库接口函数实现的查找。
由测试结果10,11，12，13可以看到，主页每次进来都可以从数据库中加载所有的数据并将主页进行渲染，并且能够根据当前用户的登录状况将右上角的用户登录情况变为对应的用户名或者昵称，或者是登录按钮，并且能够实现课程的按类管理。
由测试结果图13,14可知，注销功能是可以正常使用的。
由测试结果图15，16,17，18，19所示，可以看到对于用户未登录状态，主页可以显示课程，但是不能选课，选课则会报出请先登录的报错，如果用户的身份不是学生，则点击选课和退选按钮，会弹出报错信息you are not a student，对于连续选课的情况，也会报出对应不能重复选课和退选的报错，选课或退选成功时会成功向前端发送正确选课的反馈，并且调用数据库函数，将对应的选课或者退选操作在数据库上实现。由此可见，用户选课、退选模块成功实现。

由图20，21，22，23，24，25分别可知，对于个人中心模块，能够显示其学生正常的个人中心页面（游客和学会使用的是同一套页面框架），对于学生的个人中心可知，当对应的学生成功选择了一项课程之后，能够在他对应的个人中心页面成功的显示出来对应的选课情况，对应学生进行退选之后，能够成功的在各人中心页面进行实时的信息更新。能够根据用户登录当前的身份自动的加载不同的个人中心页面，如果个人用户的身份是老师，可以自动加载老师对应的个人中心页面，老师的个人中心包含的不是选课名称和选课概率而是发布的课程名称和对应选课课程的选课人数。在老师发布新课程之后，能够在个人中心实时更新的新发布的页面。对于没有登录的页面，会自动跳转到请登录的页面，由此可见可以看到个人中心模块能够成功实现。

由图27，28，29，30，31，32，33，34，35，36可以看到对于用户未登录的情况，是无法跳转到个人信息更改页面的，对于用户必填项没填的情况，是会根据其对应的没填的表项进行报错，也能根据填写的信息成功注册成对应的身份，对应邀请码的报错也能在后台检测并返回前端对应的报错信息。能调用数据库的接口函数正确更新对应用户的信息。由此可以看到，用户个人信息更新模块能够成功实现。

由图26，37，38，39，40,41可知，能够对特定的课程显示对应课程的信息，能够以老师的身份发布新的课程，发布的新课程能够在首页中显示出来，对于老师不存在和课程名称重复的报错也会输出到前端，如果操作成功则会在课程数据库中加入此课程数据。由此可见，课程模块能够成功实现。

由图42，43，44可知，课程讨论模块可以让未登录的用户也有权观看，但是只有登录的用户才能进行发言，发言成功后能够将对应的数据载入到数据库宏，然后再次进入讨论区时，会看到刚才的发言，发言按照发言的时间先后顺序进行排列。课程讨论模块能够成功实现。

由图45,46，47,48，49可知，课程评价模块也可以允许未登录的用户观看，但是对于想要发言的用户，则必须是选此课的学生才行，成功发言之后，也会想讨论区一样按照发言的时间先后顺序进行排列。
